<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> TEMPLETE</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, sans-serif;
      background:
        radial-gradient(circle at top left, #e0f2fe 0, transparent 50%),
        radial-gradient(circle at bottom right, #f5d0fe 0, transparent 55%),
        #f3f4f6;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 1280px;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 26px;
      box-shadow:
        0 20px 60px rgba(15, 23, 42, 0.16),
        0 0 0 1px rgba(148, 163, 184, 0.2);
      padding: 20px 22px 22px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      backdrop-filter: blur(16px);
      height: calc(100vh - 48px);
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .app-title-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .app-title {
      font-size: 20px;
      font-weight: 800;
      color: #111827;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .app-title-emoji {
      font-size: 20px;
    }

    /* âš¡ ë²„íŠ¼ (êµ¬ê¸€ì‹œíŠ¸ ì—°ê²°) */
    .app-tag {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(129, 140, 248, 0.08);
      color: #4f46e5;
      border: 1px solid rgba(129, 140, 248, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 4px 12px rgba(129, 140, 248, 0.35);
      cursor: pointer;
      border: none;
    }

    .app-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    /* header-actions / sheet-button / sheet-captionì€ ë” ì´ìƒ ì‚¬ìš© X */

    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
      flex-shrink: 0;
    }

    .search-input {
      flex: 1;
      padding: 12px 18px;
      border-radius: 999px;
      border: 1px solid rgba(209, 213, 219, 0.8);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background-color 0.15s, transform 0.05s;
      background: radial-gradient(circle at top left, #fdf2ff 0, #f9fafb 45%);
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.9),
        0 10px 30px rgba(148, 163, 184, 0.2);
    }

    .search-input::placeholder {
      color: #9ca3af;
    }

    .search-input:focus {
      border-color: #a855f7;
      box-shadow:
        0 0 0 1px rgba(168, 85, 247, 0.7),
        0 12px 32px rgba(129, 140, 248, 0.45);
      background: #ffffff;
      transform: translateY(-0.5px);
    }

    .search-button {
      padding: 0 20px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(130deg, #6366f1, #a855f7);
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 14px 30px rgba(129, 140, 248, 0.55);
      flex-shrink: 0;
    }

    .search-button:hover {
      opacity: 0.97;
      transform: translateY(-0.5px);
    }

    .search-button span.icon {
      font-size: 14px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 4px;
      flex-shrink: 0;
    }

    .result-count {
      font-size: 12px;
      color: #6b7280;
    }

    .result-count strong {
      color: #4f46e5;
    }

    /* ë¶„ë¥˜ í•„í„°ëŠ” í™”ë©´ì—ì„œ ìˆ¨ê¹€ */
    .category-filter {
      display: none;
    }

    .category-select {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }

    .type-filter {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #4b5563;
      margin-top: 4px;
    }

    .type-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      font-size: 11px;
    }

    .type-pill input {
      margin: 0;
    }

    .type-pill.active {
      border-color: #6366f1;
      background: #eef2ff;
    }

    .app-body {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.25fr);
      gap: 16px;
      flex: 1;
      min-height: 0;
    }

    /* ì™¼ìª½: ë¦¬ìŠ¤íŠ¸ */
    .list-panel {
      border-radius: 20px;
      background: linear-gradient(145deg, #f9fafb, #eef2ff);
      padding: 10px 10px 10px 12px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      display: flex;
      flex-direction: column;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      min-height: 0;
      position: relative;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .list-title {
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .list-title span.icon {
      font-size: 14px;
    }

    .list-hint {
      font-size: 11px;
      color: #9ca3af;
    }

    .results {
      flex: 1;
      overflow: auto;
      padding-right: 4px;
      border-top: 1px solid #e5e7eb;
      margin-top: 4px;
    }

    .macro-item {
      padding: 9px 6px 9px 4px;
      border-bottom: 1px dashed rgba(209, 213, 219, 0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      border-radius: 12px;
      transition: background-color 0.12s, box-shadow 0.12s, transform 0.05s, border-color 0.12s;
    }

    .macro-item:hover {
      background: rgba(224, 231, 255, 0.85);
      box-shadow:
        0 1px 0 rgba(148, 163, 184, 0.7),
        0 6px 16px rgba(129, 140, 248, 0.25);
      transform: translateY(-1px);
    }

    .macro-item.active {
      background: rgba(224, 231, 255, 1);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.9);
      border-color: transparent;
    }

    .macro-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .macro-title {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .macro-category {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 8px;
      background: #eef2ff;
      color: #4f46e5;
      border: 1px solid rgba(129, 140, 248, 0.3);
    }

    .macro-subtext {
      font-size: 11px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .copy-mini {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .copy-mini span.icon {
      font-size: 12px;
    }

    .copy-mini:hover {
      background: #e5e7eb;
    }

    .empty-state {
      padding: 24px 4px;
      text-align: center;
      color: #9ca3af;
      font-size: 13px;
    }

       // === 18) ê³ ê° ë¬¸ì˜ â†’ ë‹µë³€ ìƒì„± ===
    editorAnswerBtn.addEventListener("click", async () => {
      const question = (questionTextarea.value || "").trim();
      if (!question) {
        alert("ê³ ê°ë‹˜ì´ ë‚¨ê¸´ ë¬¸ì˜ ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const tone = getActiveTone(); // "ë°œë„" ë˜ëŠ” "ì°¨ë¶„"

      if (!OPENAI_API_KEY) {
        const key = prompt(
          "OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì´ í‚¤ëŠ” íŒŒì¼ì— ì €ì¥ë˜ì§€ ì•Šê³ , ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤)"
        );
        if (!key) {
          alert("API í‚¤ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        OPENAI_API_KEY = key.trim();
      }

      editorAnswerBtn.disabled = true;
      editorAnswerBtn.innerText = "ìƒì„± ì¤‘...";

      const toneInstructionForAnswer =
        tone === "ë°œë„"
          ? `
- ë°ê³  ì¹œê·¼í•˜ì§€ë§Œ, ìƒë‹´ì‚¬ë‹µê²Œ ë‹¨ì •í•œ ë§íˆ¬.
- 'ê³ ê°ë‹˜'ì„ ê¸°ë³¸ í˜¸ì¹­ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
- ì´ëª¨ì§€ëŠ” ì“¸ ìˆ˜ ìˆì§€ë§Œ 2ê°œ ì´ë‚´ë¡œ ì œí•œí•œë‹¤. (ì—†ì–´ë„ ê´œì°®ìŒ)
          `
          : `
- ìµœëŒ€í•œ ì°¨ë¶„í•˜ê³  ì•ˆì •ê° ìˆëŠ” í†¤.
- ê³µê°/ì•ˆì‹¬/ì‚¬ê³¼ ë¬¸ì¥ì„ 1ë¬¸ì¥ ì´ìƒ í¬í•¨í•œë‹¤.
- ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
          `;

      const systemMessageForAnswer = `
ë„ˆëŠ” í™”ì´íŠ¸ìƒŒì¦ˆ ê³ ê°ì„¼í„° ìƒë‹´ì‚¬ì•¼.

[ëª©í‘œ]
- ê³ ê°ì´ ë‚¨ê¸´ ë¬¸ì˜ ë‚´ìš©ì„ ì½ê³ , ì±„íŒ… ìƒë‹´ì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ë‹µë³€ ë©˜íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.
- í•œ ë²ˆì— ë³´ë‚¼ "í•œ ë©ì–´ë¦¬"ì˜ ë‹µë³€ìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

[í˜•ì‹]
- ê° ë¬¸ì¥ ë˜ëŠ” ì˜ë¯¸ ë‹¨ìœ„ë§ˆë‹¤ ì¤„ë°”ê¿ˆ(ì—”í„°)ì„ ë„£ì–´, ëª¨ë°”ì¼ ì±„íŒ…ì°½ì—ì„œ ì½ê¸° í¸í•˜ê²Œ ë§Œë“ ë‹¤.
- ì¡´ëŒ“ë§(ìš”/ì…ë‹ˆë‹¤)ë§Œ ì‚¬ìš©í•œë‹¤.
- ë¶ˆí•„ìš”í•œ ì¸ì‚¬(ì˜ˆ: "ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”~")ëŠ” í•œ ë²ˆë§Œ, ê³¼í•˜ì§€ ì•Šê²Œ ì‚¬ìš©í•œë‹¤.
- ë¨¸ë¦¬ë§/ê¼¬ë¦¬ë§ì€ í•„ìš”í•˜ë©´ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•´ë„ ë˜ì§€ë§Œ, ë„ˆë¬´ ê¸¸ê²Œ ëŠ˜ë¦¬ì§€ ì•ŠëŠ”ë‹¤.

[ë‚´ìš©]
- ê³ ê°ì´ ê¶ê¸ˆí•´í•˜ëŠ” í•µì‹¬ì„ ë¨¼ì € ì§šê³  ë°”ë¡œ ë‹µí•´ ì¤€ë‹¤.
- í•„ìš”í•œ ê²½ìš°, ì¶”ê°€ë¡œ í™•ì¸í•´ì•¼ í•  ì •ë³´(ì˜ˆ: ì£¼ë¬¸ë²ˆí˜¸, ì—°ë½ì²˜ ë“±)ë¥¼ ì •ì¤‘í•˜ê²Œ ìš”ì²­í•œë‹¤.
- ì¡°ê±´/ì£¼ì˜ì‚¬í•­/ì²˜ë¦¬ ì˜ˆìƒì¼ ë“± ì¤‘ìš”í•œ ì •ë³´ëŠ” ë¹¼ë¨¹ì§€ ì•Šê²Œ ë˜ë ·í•˜ê²Œ ì ëŠ”ë‹¤.

[í†¤ ê·œì¹™]
${toneInstructionForAnswer}

[ì£¼ì˜]
- ì•ˆë‚´ ë©˜íŠ¸ë§Œ ì¶œë ¥í•œë‹¤. (ì„¤ëª…, ë”°ì˜´í‘œ, ë¶ˆë¦¿ ë“±ì€ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.)
      `.trim();

      const userMessageForAnswer = `
[ê³ ê° ë¬¸ì˜ ë‚´ìš©]
${question}
      `.trim();

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + OPENAI_API_KEY
          },
          body: JSON.stringify({
            model: "gpt-4.1-mini",
            messages: [
              { role: "system", content: systemMessageForAnswer },
              { role: "user", content: userMessageForAnswer }
            ]
          })
        });

        const data = await response.json();

        if (data.error) {
          console.error("API ì˜¤ë¥˜:", data.error);
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error.message);
        } else {
          const answer = data.choices?.[0]?.message?.content?.trim();
          if (answer) {
            // ê¸°ì¡´ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë®ì–´ì“¸ì§€ ë¬¼ì–´ë³´ê³ , ì—†ìœ¼ë©´ ë°”ë¡œ ë„£ê¸°
            if (editorTextarea.value.trim()) {
              const replace = confirm("í¸ì§‘ì°½ ë‚´ìš©ì„ ìƒˆë¡œ ìƒì„±ëœ ë‹µë³€ìœ¼ë¡œ êµì²´í• ê¹Œìš”?");
              if (replace) {
                editorTextarea.value = answer;
              } else {
                editorTextarea.value = editorTextarea.value.replace(/\s*$/, "") + "\n\n" + answer;
              }
            } else {
              editorTextarea.value = answer;
            }
            updateCharCount();
            showToast("ë¬¸ì˜ ë‹µë³€ì„ ìƒì„±í–ˆì–´ìš”");
          }
        }
      } catch (err) {
        console.error("ë„¤íŠ¸ì›Œí¬/ìš”ì²­ ì—ëŸ¬:", err);
        alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (err?.message || err));
      } finally {
        editorAnswerBtn.disabled = false;
        editorAnswerBtn.innerText = "ë‹µë³€ ìƒì„±";
      }
    });


    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      background: #111827;
      color: #ffffff;
      font-size: 13px;
      padding: 8px 14px;
      border-radius: 999px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.18s.ease-out;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .preview-bubble {
      position: absolute;
      top: 60px;
      left: calc(100% + 14px);
      width: 260px;
      max-height: 200px;
      background: radial-gradient(circle at top left, rgba(244, 244, 255, 0.98), rgba(250, 250, 255, 0.96));
      color: #111827;
      border-radius: 18px;
      padding: 10px 12px;
      box-shadow:
        0 20px 45px rgba(129, 140, 248, 0.45),
        0 0 0 1px rgba(196, 181, 253, 0.9);
      font-size: 12px;
      backdrop-filter: blur(18px);
      z-index: 20;
      display: none;
      transition: opacity 0.15s ease-out, transform 0.15s ease-out;
    }

    .preview-bubble.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .preview-title {
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #4b5563;
    }

    .preview-title span.icon {
      font-size: 14px;
    }

    .preview-body {
      font-size: 12px;
      line-height: 1.5;
      max-height: 150px;
      overflow: auto;
      white-space: pre-wrap;
      color: #374151;
    }

    @media (max-width: 900px) {
      body { padding: 12px; }
      .app { padding: 16px 14px 16px; height: auto; }
      .app-body {
        grid-template-columns: 1fr;
      }
      .editor-panel {
        min-height: 260px;
      }
      .preview-bubble {
        position: fixed;
        right: 16px;
        left: 16px;
        top: auto;
        bottom: 80px;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-header">
      <div class="app-title-wrap">
        <div class="app-title-row">
          <div class="app-title">
            í…œí”Œ
          </div>
          <!-- âš¡ ë²„íŠ¼: êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° -->
          <button id="sheetOpenBtn" class="app-tag" type="button" title="Google Sheets ì—´ê¸°">
            <span>âš¡</span>
          </button>
        </div>
        <div class="app-subtitle">
        </div>
      </div>
      <!-- ğŸ”´ Google Sheets ì—´ê¸° ë²„íŠ¼ ì˜ì—­ ì œê±° -->
    </div>

    <div class="search-box">
      <input
        id="searchInput"
        class="search-input"
        type="text"
        placeholder="ë©”í¬ë¡œ ì œëª© ë˜ëŠ” í‚¤ì›Œë“œë¥¼ ê²€ìƒ‰í•´ ë³´ì„¸ìš” (ì˜ˆ: ë°°ì†¡, êµí™˜, ìœ„ë¡œ ë©˜íŠ¸ ë“±)"
      />
      <button id="searchButton" class="search-button" type="button">
        <span class="icon">ğŸ”</span>
        <span>ê²€ìƒ‰</span>
      </button>
    </div>

    <div class="top-row">
      <div>
        <div id="resultCount" class="result-count">ì´ <strong>0</strong>ê°œ</div>
        <div class="type-filter">
          êµ¬ë¶„:
          <label class="type-pill active">
            <input type="radio" name="typeFilter" value="" checked />
            ì „ì²´
          </label>
          <label class="type-pill">
            <input type="radio" name="typeFilter" value="í†µí•©" />
            í†µí•©
          </label>
          <label class="type-pill">
            <input type="radio" name="typeFilter" value="ì•Œë¦¼í†¡" />
            í†¡
          </label>
          <label class="type-pill">
            <input type="radio" name="typeFilter" value="ì±„íŒ…" />
            ì±„íŒ…
          </label>
          <label class="type-pill">
            <input type="radio" name="typeFilter" value="FAQ" />
            FAQ
          </label>
        </div>
      </div>
      <div class="category-filter">
        ë¶„ë¥˜:
        <select id="categorySelect" class="category-select">
          <option value="">ì „ì²´</option>
        </select>
      </div>
    </div>

    <div class="app-body">
      <!-- ì™¼ìª½: ë¦¬ìŠ¤íŠ¸ -->
      <div class="list-panel">
        <div class="list-header">
          <div class="list-title">
            <span class="icon">ğŸ“š</span>
           ã…£LIST
          </div>
        </div>

        <div id="previewBubble" class="preview-bubble">
          <div class="preview-title">
            <span class="icon">ğŸ‘€</span>
            <span id="previewTitleText">ë¯¸ë¦¬ë³´ê¸°</span>
          </div>
          <div id="previewBodyText" class="preview-body"></div>
        </div>

        <div id="results" class="results"></div>
      </div>

           <!-- ì˜¤ë¥¸ìª½: í¸ì§‘ -->
      <div class="editor-panel">
        <div class="editor-header">
          <div class="editor-title-wrap">
            <!-- ìœ—ì¤„: ë¼ë²¨ + í†¤ -->
            <div class="editor-top-row">
              <div class="editor-label">ACTIVE MACRO</div>
              <div class="tone-controls">
                <button type="button" class="tone-pill active" data-value="ë°œë„">ë°œë„</button>
                <button type="button" class="tone-pill" data-value="ì°¨ë¶„">ì°¨ë¶„</button>
              </div>
            </div>

            <!-- ë‘˜ì§¸ ì¤„: ì œëª©/ì¹´í…Œê³ ë¦¬ -->
            <div class="editor-title-line">
              <div id="editorTitle" class="editor-title-text"></div>
              <div id="editorCategory" class="editor-category-pill" style="display:none;"></div>
            </div>

            <!-- ì…‹ì§¸ ì¤„: ìŠ¤ë‹ˆí« ë²„íŠ¼ (ë¨¸ë¦¬ë§/ì‚¬ê³¼/ê¼¬ë¦¬ë§) -->
            <div class="snippet-controls">
              <button type="button" class="snippet-btn" data-snippet="header">ë¨¸ë¦¬ë§</button>
              <button type="button" class="snippet-btn" data-snippet="apology">ì‚¬ê³¼</button>
              <button type="button" class="snippet-btn" data-snippet="footer">ê¼¬ë¦¬ë§</button>
            </div>
          </div>

          <!-- ìš°ì¸¡: ë²„íŠ¼ë“¤ë§Œ ì‹¬í”Œí•˜ê²Œ -->
          <div class="editor-actions">
            <button id="editorCopyBtn" class="copy-main" type="button">
              <span class="icon">ğŸ“‹</span>
              <span>ë³µì‚¬</span>
            </button>
            <button id="editorPolishBtn" class="secondary-btn" type="button">
              <span class="icon">âœ¨</span>
              <span>AIë¡œ ë‹¤ë“¬ê¸°</span>
            </button>
            <button id="editorResetBtn" class="ghost-btn" type="button" disabled>ì›ë³¸</button>
          </div>
        </div>

        <!-- ìƒˆ ê¸°ëŠ¥: ê³ ê° ë¬¸ì˜ â†’ ë‹µë³€ ìƒì„± -->
        <div class="answer-row">
          <textarea
            id="questionTextarea"
            class="question-textarea"
            placeholder="ê³ ê°ë‹˜ì´ ë‚¨ê¸´ ë¬¸ì˜ ë‚´ìš©ì„ ë¶™ì—¬ë„£ê³ , â€˜ë‹µë³€ ìƒì„±â€™ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”."
          ></textarea>
          <div class="answer-side">
            <button id="editorAnswerBtn" class="answer-btn" type="button">
              <span class="icon">ğŸ¤–</span>
              <span>ë‹µë³€ ìƒì„±</span>
            </button>
            <p class="answer-hint">
              â€¢ ìœ„ ë¬¸ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ<br />
              â€¢ í˜„ì¬ ì„ íƒëœ í†¤(ë°œë„/ì°¨ë¶„)ì— ë§ì¶°<br />
              â€¢ ì•„ë˜ í¸ì§‘ì°½ì— ë°”ë¡œ ë¶™ì—¬ ë„£ì–´ì¤˜ìš”.
            </p>
          </div>
        </div>

        <textarea
          id="editorTextarea"
          class="editor-textarea"
          placeholder="ì—¬ê¸°ì— ì‚¬ìš©í•  ë©˜íŠ¸ë¥¼ í¸ì§‘í•´ ì£¼ì„¸ìš”."
        ></textarea>

        <div class="editor-footer">
          <span id="editorMeta">ì„ íƒëœ ë©”í¬ë¡œ ì—†ìŒ</span>
          <span id="charCount">0ì</span>
        </div>
      </div>


  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast">ë³µì‚¬</div>

  <script>
    // === ê³µí†µ: í† ìŠ¤íŠ¸ ===
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function showToast(message) {
      toastEl.textContent = message || "ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤";
      toastEl.classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toastEl.classList.remove("show");
      }, 1500);
    }

    // === 1) êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì •ê°’ ===
    const SHEET_ID = "1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM";
    const SHEET_GID = "1260123292";
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
    const SHEET_LINK = "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/edit?gid=1260123292#gid=1260123292";

    const DEFAULT_HEADER = "ì•ˆë…•í•˜ì„¸ìš” í™”ì´íŠ¸ìƒŒì¦ˆì…ë‹ˆë‹¤.";
    const DEFAULT_FOOTER = "í™”ì´íŠ¸ìƒŒì¦ˆë¥¼ ì°¾ì•„ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.";
    const DEFAULT_APOLOGY = "ë” ì¢‹ì€ ìƒí’ˆê³¼ ì„œë¹„ìŠ¤ë¡œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.";

    let macros = [];
    let filteredMacros = [];
    let activeMacro = null;

    let OPENAI_API_KEY = "";

    // === 2) CSV íŒŒì„œ ===
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let insideQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const next = text[i + 1];

        if (char === '"' && insideQuotes && next === '"') {
          cur += '"';
          i++;
        } else if (char === '"') {
          insideQuotes = !insideQuotes;
        } else if (char === "," && !insideQuotes) {
          row.push(cur);
          cur = "";
        } else if ((char === "\n" || char === "\r") && !insideQuotes) {
          if (cur.length > 0 || row.length > 0) {
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
          }
        } else {
          cur += char;
        }
      }
      if (cur.length > 0 || row.length > 0) {
        row.push(cur);
        rows.push(row);
      }
      return rows;
    }

    // === 3) êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¡œë“œ ===
    async function loadMacrosFromSheet() {
      try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        const rows = parseCSV(text);
        const dataRows = rows.slice(1);

        macros = dataRows
          .map((cols, idx) => {
            const major = (cols[0] || "").trim();
            const minor = (cols[1] || "").trim();
            const content = (cols[2] || "").trim();
            const typeTag = (cols[3] || "").trim();

            if (!major && !minor && !content) return null;

            return {
              id: `macro-${idx}`,
              title: major,
              category: minor,
              content,
              typeTag,
            };
          })
          .filter(Boolean);

        filteredMacros = macros.slice();
        initCategoryOptions();
        renderResults(filteredMacros);
      } catch (e) {
        console.error(e);
        alert("êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê³µìœ  ì„¤ì •ê³¼ URLì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }

    // === 4) DOM ìš”ì†Œ ===
    const searchInput = document.getElementById("searchInput");
    const searchButton = document.getElementById("searchButton");
    const resultsEl = document.getElementById("results");
    const resultCountEl = document.getElementById("resultCount");
    const categorySelect = document.getElementById("categorySelect");

    const editorTitleEl = document.getElementById("editorTitle");
    const editorCategoryEl = document.getElementById("editorCategory");
    const editorTextarea = document.getElementById("editorTextarea");
    const editorCopyBtn = document.getElementById("editorCopyBtn");
    const editorResetBtn = document.getElementById("editorResetBtn");
    const editorMetaEl = document.getElementById("editorMeta");
    const charCountEl = document.getElementById("charCount");
    const editorPolishBtn = document.getElementById("editorPolishBtn");

    const previewBubbleEl = document.getElementById("previewBubble");
    const previewTitleTextEl = document.getElementById("previewTitleText");
    const previewBodyTextEl = document.getElementById("previewBodyText");

    const questionTextarea = document.getElementById("questionTextarea");
    const editorAnswerBtn = document.getElementById("editorAnswerBtn");

    const sheetOpenBtn = document.getElementById("sheetOpenBtn");
    const snippetButtons = document.querySelectorAll(".snippet-btn");

    const listPanelEl = document.querySelector(".list-panel");
    const typeFilterRadios = document.querySelectorAll('input[name="typeFilter"]');
    const typeFilterLabels = document.querySelectorAll(".type-pill");

    const toneButtons = document.querySelectorAll(".tone-pill");

    // === 5) ì‹œíŠ¸ ì—´ê¸° ë²„íŠ¼ (âš¡) ===
    sheetOpenBtn.addEventListener("click", () => {
      window.open(SHEET_LINK, "_blank", "noopener");
    });

    // === 6) ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ìƒì„± ===
    function initCategoryOptions() {
      while (categorySelect.options.length > 1) {
        categorySelect.remove(1);
      }

      const categories = Array.from(
        new Set(
          macros
            .map((m) => (m.category || "").trim())
            .filter((c) => c.length > 0)
        )
      ).sort();

      categories.forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    // === 7) ê²€ìƒ‰ & í•„í„° ===
    function searchMacros() {
      const query = searchInput.value.trim().toLowerCase();
      const selectedCategory = categorySelect.value;
      const selectedTypeRadio = document.querySelector('input[name="typeFilter"]:checked');
      const selectedType = selectedTypeRadio ? selectedTypeRadio.value : "";

      filteredMacros = macros;

      if (selectedCategory) {
        filteredMacros = filteredMacros.filter(
          (m) => (m.category || "").trim() === selectedCategory
        );
      }

      if (selectedType) {
        filteredMacros = filteredMacros.filter(
          (m) => (m.typeTag || "").trim() === selectedType
        );
      }

      if (query) {
        filteredMacros = filteredMacros.filter((m) => {
          const title = (m.title || "").toLowerCase();
          const category = (m.category || "").toLowerCase();
          const content = (m.content || "").toLowerCase();
          return (
            title.includes(query) ||
            category.includes(query) ||
            content.includes(query)
          );
        });
      }

      renderResults(filteredMacros);
      hidePreview();
    }

    // === 8) ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ===
    function renderResults(list) {
      resultsEl.innerHTML = "";
      resultCountEl.innerHTML = `ì´ <strong>${list.length}</strong>ê°œ ë©”í¬ë¡œ`;

      if (list.length === 0) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. í‚¤ì›Œë“œë¥¼ ë°”ê¿”ì„œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
        resultsEl.appendChild(empty);
        return;
      }

      list.forEach((macro) => {
        const item = document.createElement("div");
        item.className = "macro-item";
        item.dataset.id = macro.id;

        if (activeMacro && activeMacro.id === macro.id) {
          item.classList.add("active");
        }

        const header = document.createElement("div");
        header.className = "macro-header";

        const titleWrap = document.createElement("div");
        titleWrap.className = "macro-title";
        titleWrap.textContent = macro.title || "(ëŒ€ë¶„ë¥˜ ì—†ìŒ)";

        if (macro.category) {
          const cat = document.createElement("span");
          cat.className = "macro-category";
          cat.textContent = macro.category;
          titleWrap.appendChild(cat);
        }

        const miniCopy = document.createElement("button");
        miniCopy.className = "copy-mini";
        miniCopy.type = "button";
        miniCopy.innerHTML = `<span class="icon">ğŸ“‹</span><span>ì›ë³¸</span>`;
        miniCopy.addEventListener("click", (e) => {
          e.stopPropagation();
          copyToClipboard(macro.content || "");
        });

        header.appendChild(titleWrap);
        header.appendChild(miniCopy);

        const sub = document.createElement("div");
        sub.className = "macro-subtext";
        const stripped = (macro.content || "").replace(/\s+/g, " ");
        sub.textContent = stripped.slice(0, 60) + (stripped.length > 60 ? "â€¦" : "");

        item.appendChild(header);
        item.appendChild(sub);

        item.addEventListener("click", () => {
          selectMacro(macro);
          document.querySelectorAll(".macro-item").forEach((el) => {
            el.classList.remove("active");
          });
          item.classList.add("active");
        });

        item.addEventListener("mouseenter", () => {
          showPreview(macro, item);
        });
        item.addEventListener("mouseleave", () => {
          hidePreview();
        });

        resultsEl.appendChild(item);
      });
    }

    resultsEl.addEventListener("mouseleave", hidePreview);

    // === 9) ë©”í¬ë¡œ ì„ íƒ â†’ í¸ì§‘ì°½ìœ¼ë¡œ ë¡œë“œ ===
    function selectMacro(macro) {
      activeMacro = { ...macro };

      editorTitleEl.textContent = activeMacro.title || "(ëŒ€ë¶„ë¥˜ ì—†ìŒ)";
      if (activeMacro.category) {
        editorCategoryEl.textContent = activeMacro.category;
        editorCategoryEl.style.display = "inline-block";
      } else {
        editorCategoryEl.style.display = "none";
      }

      editorTextarea.disabled = false;
      editorCopyBtn.disabled = false;
      editorResetBtn.disabled = false;
      editorPolishBtn.disabled = false;

      editorTextarea.value = activeMacro.content || "";
      updateCharCount();

      if (activeMacro.typeTag) {
        editorMetaEl.textContent = `êµ¬ë¶„: ${activeMacro.typeTag}`;
      } else {
        editorMetaEl.textContent = "ì„ íƒëœ ë©”í¬ë¡œ í¸ì§‘ ì¤‘";
      }
    }

    // === 10) ê¸€ììˆ˜ í‘œì‹œ ===
    function updateCharCount() {
      const len = editorTextarea.value.length;
      charCountEl.textContent = `${len}ì`;
    }

    editorTextarea && editorTextarea.addEventListener("input", updateCharCount);

    // === 11) í´ë¦½ë³´ë“œ ë³µì‚¬ ===
    function copyToClipboard(text) {
      if (!text) return;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(text)
          .then(() => showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤"))
          .catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.style.position = "fixed";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();

      try {
        document.execCommand("copy");
        showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤");
      } catch (e) {
        alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì„ íƒí•´ì„œ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
      } finally {
        document.body.removeChild(textarea);
      }
    }

    editorCopyBtn.addEventListener("click", () => {
      const text = editorTextarea.value || "";
      if (!text) return;
      copyToClipboard(text);
    });

    // === 12) ì›ë³¸ìœ¼ë¡œ ë˜ëŒë¦¬ê¸° ===
    editorResetBtn.addEventListener("click", () => {
      if (!activeMacro) return;
      editorTextarea.value = activeMacro.content || "";
      updateCharCount();
      showToast("ì›ë³¸ìœ¼ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤");
    });

    // === 13) ë¯¸ë¦¬ë³´ê¸° ë²„ë¸” ===
    const listPanelElRef = document.querySelector(".list-panel");

    function showPreview(macro, anchorEl) {
      if (!macro || !macro.content || !anchorEl) {
        hidePreview();
        return;
      }
      previewTitleTextEl.textContent = macro.title || "ë¯¸ë¦¬ë³´ê¸°";
      previewBodyTextEl.textContent = macro.content;

      previewBubbleEl.style.display = "block";
      previewBubbleEl.style.opacity = "0";

      const anchorRect = anchorEl.getBoundingClientRect();
      const panelRect = listPanelElRef.getBoundingClientRect();
      const bubbleHeight = previewBubbleEl.offsetHeight || 160;

      let top =
        anchorRect.top -
        panelRect.top +
        anchorRect.height / 2 -
        bubbleHeight / 2;

      const minTop = 40;
      const maxTop = listPanelElRef.clientHeight - bubbleHeight - 16;
      top = Math.max(minTop, Math.min(top, maxTop));

      previewBubbleEl.style.top = `${top}px`;
      previewBubbleEl.style.opacity = "1";
      previewBubbleEl.classList.add("visible");
    }

    function hidePreview() {
      previewBubbleEl.classList.remove("visible");
      previewBubbleEl.style.display = "none";
    }

    // === 14) ìŠ¤ë‹ˆí« ë²„íŠ¼ ===
    function applySnippet(type) {
      if (editorTextarea.disabled) return;

      let text = editorTextarea.value || "";
      const trimmed = text.trim();

      if (type === "header") {
        if (trimmed.startsWith(DEFAULT_HEADER)) {
          showToast("ì´ë¯¸ ë¨¸ë¦¬ë§ì´ ë“¤ì–´ê°€ ìˆì–´ìš”");
          return;
        }
        const body = text.replace(/^\s+/, "");
        editorTextarea.value = DEFAULT_HEADER + (body ? "\n\n" + body : "");
      } else if (type === "footer") {
        if (trimmed.endsWith(DEFAULT_FOOTER)) {
          showToast("ì´ë¯¸ ê¼¬ë¦¬ë§ì´ ë“¤ì–´ê°€ ìˆì–´ìš”");
          return;
        }
        const withoutTrailing = text.replace(/\s+$/, "");
        editorTextarea.value = (withoutTrailing ? withoutTrailing + "\n\n" : "") + DEFAULT_FOOTER;
      } else if (type === "apology") {
        if (trimmed.includes("ë” ì¢‹ì€ ìƒí’ˆê³¼ ì„œë¹„ìŠ¤ë¡œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤")) {
          showToast("ì´ë¯¸ ì‚¬ê³¼ ë¬¸êµ¬ê°€ ë“¤ì–´ê°€ ìˆì–´ìš”");
          return;
        }
        const withoutTrailing = text.replace(/\s+$/, "");
        editorTextarea.value = (withoutTrailing ? withoutTrailing + "\n\n" : "") + DEFAULT_APOLOGY;
      }

      updateCharCount();
    }

    snippetButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.snippet;
        applySnippet(type);
      });
    });

    // === 15) íƒ€ì… í•„í„° ===
    searchButton.addEventListener("click", searchMacros);
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchMacros();
    });
    categorySelect.addEventListener("change", searchMacros);

    typeFilterRadios.forEach((radio) => {
      radio.addEventListener("change", () => {
        typeFilterLabels.forEach((label) => label.classList.remove("active"));
        const selected = document.querySelector('input[name="typeFilter"]:checked');
        if (selected) {
          const label = selected.closest(".type-pill");
          if (label) label.classList.add("active");
        }
        searchMacros();
      });
    });

    // === 16) í†¤ ëª¨ë“œ í† ê¸€ ===
    function setupToneToggle() {
      toneButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          toneButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });
    }

    function getActiveTone() {
      const active = Array.from(toneButtons).find(b => b.classList.contains("active"));
      return active ? active.getAttribute("data-value") : "ë°œë„";
    }

    setupToneToggle();

    // === 17) AIë¡œ ë‹¤ë“¬ê¸° ===
    editorPolishBtn.addEventListener("click", async () => {
      if (editorTextarea.disabled) return;

      const text = editorTextarea.value.trim();
      if (!text) {
        alert("ë‹¤ë“¬ì„ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const tone = getActiveTone(); // "ë°œë„" ë˜ëŠ” "ì°¨ë¶„"

      if (!OPENAI_API_KEY) {
        const key = prompt(
          "OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì´ í‚¤ëŠ” íŒŒì¼ì— ì €ì¥ë˜ì§€ ì•Šê³ , ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤)"
        );
        if (!key) {
          alert("API í‚¤ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        OPENAI_API_KEY = key.trim();
      }

      editorPolishBtn.disabled = true;
      editorPolishBtn.innerText = "ë‹¤ë“¬ëŠ” ì¤‘...";

      const toneInstruction =
        tone === "ë°œë„"
          ? `
- í†¤: ë°œë„
- í† ìŠ¤ ê³ ê°ì„¼í„°ì²˜ëŸ¼ ë‹¨ì •í•˜ì§€ë§Œ ì¹œê·¼í•œ ë§íˆ¬.
- 'ê³ ê°ë‹˜', 'ë„ì™€ë“œë¦¬ë‹¤', 'í™•ì¸í•´ë³´ê³  ì•ˆë‚´ë“œë¦¬ë‹¤' ê°™ì€ í‘œí˜„ ì¤‘ì‹¬.
- ì´ëª¨ì§€ëŠ” ğŸ˜ŠğŸ™‚âœ¨ğŸ’¬ğŸ’¡âœ… ì •ë„ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ë§ë³´ë‹¤ ë§ì•„ì§€ì§€ ì•Šê²Œ.
- 'ã…‹ã…‹', 'ã…ã…', ê³¼í•œ ë°˜ë§Â·ì¥ë‚œìŠ¤ëŸ¬ìš´ ì–´íˆ¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
          `
          : `
- í†¤: ì°¨ë¶„
- ì˜ˆë¯¼í•˜ê±°ë‚˜ ë¶ˆí¸í•¨ì„ ëŠë¼ëŠ” ê³ ê°ë‹˜ì„ ìƒëŒ€í•œë‹¤ê³  ê°€ì •í•œë‹¤.
- ê³µê°Â·ì‚¬ê³¼ í‘œí˜„ì„ 1ë¬¸ì¥ ì´ìƒ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•œë‹¤.
  (ì˜ˆ: "ë¶ˆí¸ì„ ê²ªìœ¼ì…¨ì„ ê²ƒ ê°™ì•„ìš”.", "ê±±ì •ë˜ì…¨ì„ í…ë° ì£„ì†¡í•©ë‹ˆë‹¤." ë“±)
- ë§íˆ¬ëŠ” ë˜ë ·í•˜ê³  ë‹¨ì •í•˜ê²Œ, ìµœëŒ€í•œ ì•ˆì •ê° ìˆê²Œ ìœ ì§€í•œë‹¤.
- ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê±°ë‚˜, ì •ë§ í•„ìš”í•œ ê²½ìš°ì—ë§Œ 1ê°œ ì´ë‚´ë¡œ ì œí•œí•œë‹¤.
          `;

      const systemMessage = `
ë„ˆëŠ” ê³ ê° ìƒë‹´ ì±„íŒ… ë©˜íŠ¸ë¥¼ ë‹¤ë“¬ëŠ” ë¹„ì„œì•¼.

[ê¸°ë³¸ ê·œì¹™]
- ëª¨ë°”ì¼ ì±„íŒ… ìƒë‹´ ê¸°ì¤€ìœ¼ë¡œ, í•œ ëˆˆì— ì½ê¸° í¸í•´ì•¼ í•œë‹¤.
- ê° ë¬¸ì¥ ë’¤ì—ëŠ” ì¤„ë°”ê¿ˆ(ì—”í„°)ì„ ë„£ì–´ ì±„íŒ…ì²˜ëŸ¼ í•œ ì¤„ì”© ë³´ì´ê²Œ í•œë‹¤.
- ì›ë¬¸ì— ìˆëŠ” ì •ë³´, ìˆ«ì, ì¡°ê±´, ì£¼ì˜ì‚¬í•­ì€ ì ˆëŒ€ ë¹¼ì§€ ë§ ê²ƒ.
- ë‚´ìš©ì„ ìš”ì•½í•˜ì§€ ë§ê³ , ì˜ë¯¸ì™€ ë‰˜ì•™ìŠ¤ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì •ë¦¬í•œë‹¤.
- 'ã…‹ã…‹', 'ã…ã…', ê³¼ë„í•œ ë°˜ë§Â·ì¸í„°ë„· ìŠ¬ë­ì€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ì¡´ëŒ“ë§(ìš”/ì…ë‹ˆë‹¤) ìœ„ì£¼ë¡œ, ìƒë‹´ì‚¬ë‹¤ìš´ ë‹¨ì •í•œ ì–´íˆ¬ë¥¼ ìœ ì§€í•œë‹¤.

[í†¤ ëª¨ë“œ ê·œì¹™]
${toneInstruction}

[ì¶œë ¥ í˜•ì‹]
- ì™„ì„±ëœ ìƒë‹´ "í•œ ë²ˆ"ì— ë³´ë‚¼ ë©˜íŠ¸ë§Œ ì¶œë ¥í•œë‹¤.
- ë¶ˆí•„ìš”í•œ ì„¤ëª…, ë”°ì˜´í‘œ, ë¨¸ë¦¬ë§(ì˜ˆ: "ìˆ˜ì •ëœ ë©˜íŠ¸:" ë“±)ì€ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.
      `.trim();

      const userMessage = `
[ìƒë‹´ì›ì´ ë³´ë‚¼ ì´ˆì•ˆ]
${text}
      `.trim();

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + OPENAI_API_KEY
          },
          body: JSON.stringify({
            model: "gpt-4.1-mini",
            messages: [
              { role: "system", content: systemMessage },
              { role: "user", content: userMessage }
            ]
          })
        });

        const data = await response.json();

        if (data.error) {
          console.error("API ì˜¤ë¥˜:", data.error);
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error.message);
        } else {
          const polished = data.choices?.[0]?.message?.content?.trim();
          if (polished) {
            editorTextarea.value = polished;
            updateCharCount();
            showToast("AIë¡œ ë‹¤ë“¬ì—ˆì–´ìš”");
          }
        }
      } catch (err) {
        console.error("ë„¤íŠ¸ì›Œí¬/ìš”ì²­ ì—ëŸ¬:", err);
        alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (err?.message || err));
      } finally {
        editorPolishBtn.disabled = false;
        editorPolishBtn.innerText = "AIë¡œ ë‹¤ë“¬ê¸°";
      }
    });
    // === 18) ê³ ê° ë¬¸ì˜ â†’ ë‹µë³€ ìƒì„± ===
    editorAnswerBtn.addEventListener("click", async () => {
      const question = (questionTextarea.value || "").trim();
      if (!question) {
        alert("ê³ ê°ë‹˜ì´ ë‚¨ê¸´ ë¬¸ì˜ ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const tone = getActiveTone(); // "ë°œë„" ë˜ëŠ” "ì°¨ë¶„"

      if (!OPENAI_API_KEY) {
        const key = prompt(
          "OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì´ í‚¤ëŠ” íŒŒì¼ì— ì €ì¥ë˜ì§€ ì•Šê³ , ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤)"
        );
        if (!key) {
          alert("API í‚¤ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        OPENAI_API_KEY = key.trim();
      }

      editorAnswerBtn.disabled = true;
      editorAnswerBtn.innerText = "ìƒì„± ì¤‘...";

      const toneInstructionForAnswer =
        tone === "ë°œë„"
          ? `
- ë°ê³  ì¹œê·¼í•˜ì§€ë§Œ, ìƒë‹´ì‚¬ë‹µê²Œ ë‹¨ì •í•œ ë§íˆ¬.
- 'ê³ ê°ë‹˜'ì„ ê¸°ë³¸ í˜¸ì¹­ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
- ì´ëª¨ì§€ëŠ” ì“¸ ìˆ˜ ìˆì§€ë§Œ 2ê°œ ì´ë‚´ë¡œ ì œí•œí•œë‹¤. (ì—†ì–´ë„ ê´œì°®ìŒ)
          `
          : `
- ìµœëŒ€í•œ ì°¨ë¶„í•˜ê³  ì•ˆì •ê° ìˆëŠ” í†¤.
- ê³µê°/ì•ˆì‹¬/ì‚¬ê³¼ ë¬¸ì¥ì„ 1ë¬¸ì¥ ì´ìƒ í¬í•¨í•œë‹¤.
- ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
          `;

      const systemMessageForAnswer = `
ë„ˆëŠ” í™”ì´íŠ¸ìƒŒì¦ˆ ê³ ê°ì„¼í„° ìƒë‹´ì‚¬ì•¼.

[ëª©í‘œ]
- ê³ ê°ì´ ë‚¨ê¸´ ë¬¸ì˜ ë‚´ìš©ì„ ì½ê³ , ì±„íŒ… ìƒë‹´ì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ë‹µë³€ ë©˜íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.
- í•œ ë²ˆì— ë³´ë‚¼ "í•œ ë©ì–´ë¦¬"ì˜ ë‹µë³€ìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

[í˜•ì‹]
- ê° ë¬¸ì¥ ë˜ëŠ” ì˜ë¯¸ ë‹¨ìœ„ë§ˆë‹¤ ì¤„ë°”ê¿ˆ(ì—”í„°)ì„ ë„£ì–´, ëª¨ë°”ì¼ ì±„íŒ…ì°½ì—ì„œ ì½ê¸° í¸í•˜ê²Œ ë§Œë“ ë‹¤.
- ì¡´ëŒ“ë§(ìš”/ì…ë‹ˆë‹¤)ë§Œ ì‚¬ìš©í•œë‹¤.
- ë¶ˆí•„ìš”í•œ ì¸ì‚¬(ì˜ˆ: "ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”~")ëŠ” í•œ ë²ˆë§Œ, ê³¼í•˜ì§€ ì•Šê²Œ ì‚¬ìš©í•œë‹¤.
- ë¨¸ë¦¬ë§/ê¼¬ë¦¬ë§ì€ í•„ìš”í•˜ë©´ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•´ë„ ë˜ì§€ë§Œ, ë„ˆë¬´ ê¸¸ê²Œ ëŠ˜ë¦¬ì§€ ì•ŠëŠ”ë‹¤.

[ë‚´ìš©]
- ê³ ê°ì´ ê¶ê¸ˆí•´í•˜ëŠ” í•µì‹¬ì„ ë¨¼ì € ì§šê³  ë°”ë¡œ ë‹µí•´ ì¤€ë‹¤.
- í•„ìš”í•œ ê²½ìš°, ì¶”ê°€ë¡œ í™•ì¸í•´ì•¼ í•  ì •ë³´(ì˜ˆ: ì£¼ë¬¸ë²ˆí˜¸, ì—°ë½ì²˜ ë“±)ë¥¼ ì •ì¤‘í•˜ê²Œ ìš”ì²­í•œë‹¤.
- ì¡°ê±´/ì£¼ì˜ì‚¬í•­/ì²˜ë¦¬ ì˜ˆìƒì¼ ë“± ì¤‘ìš”í•œ ì •ë³´ëŠ” ë¹¼ë¨¹ì§€ ì•Šê²Œ ë˜ë ·í•˜ê²Œ ì ëŠ”ë‹¤.

[í†¤ ê·œì¹™]
${toneInstructionForAnswer}

[ì£¼ì˜]
- ì•ˆë‚´ ë©˜íŠ¸ë§Œ ì¶œë ¥í•œë‹¤. (ì„¤ëª…, ë”°ì˜´í‘œ, ë¶ˆë¦¿ ë“±ì€ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.)
      `.trim();

      const userMessageForAnswer = `
[ê³ ê° ë¬¸ì˜ ë‚´ìš©]
${question}
      `.trim();

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + OPENAI_API_KEY
          },
          body: JSON.stringify({
            model: "gpt-4.1-mini",
            messages: [
              { role: "system", content: systemMessageForAnswer },
              { role: "user", content: userMessageForAnswer }
            ]
          })
        });

        const data = await response.json();

        if (data.error) {
          console.error("API ì˜¤ë¥˜:", data.error);
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error.message);
        } else {
          const answer = data.choices?.[0]?.message?.content?.trim();
          if (answer) {
            // ê¸°ì¡´ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë®ì–´ì“¸ì§€ ë¬¼ì–´ë³´ê³ , ì—†ìœ¼ë©´ ë°”ë¡œ ë„£ê¸°
            if (editorTextarea.value.trim()) {
              const replace = confirm("í¸ì§‘ì°½ ë‚´ìš©ì„ ìƒˆë¡œ ìƒì„±ëœ ë‹µë³€ìœ¼ë¡œ êµì²´í• ê¹Œìš”?");
              if (replace) {
                editorTextarea.value = answer;
              } else {
                editorTextarea.value = editorTextarea.value.replace(/\s*$/, "") + "\n\n" + answer;
              }
            } else {
              editorTextarea.value = answer;
            }
            updateCharCount();
            showToast("ë¬¸ì˜ ë‹µë³€ì„ ìƒì„±í–ˆì–´ìš”");
          }
        }
      } catch (err) {
        console.error("ë„¤íŠ¸ì›Œí¬/ìš”ì²­ ì—ëŸ¬:", err);
        alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (err?.message || err));
      } finally {
        editorAnswerBtn.disabled = false;
        editorAnswerBtn.innerText = "ë‹µë³€ ìƒì„±";
      }
    });

    // í˜ì´ì§€ ì—´ë¦¬ë©´ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    loadMacrosFromSheet();

    
  </script>
</body>
</html>
